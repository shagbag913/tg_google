#!/usr/bin/env bash

FACTURL="https://developers.google.com/android/images"
OTAURL="https://developers.google.com/android/ota"
FACTURLCONTENT=$(curl $FACTURL)
OTAURLCONTENT=$(curl $OTAURL)
DEVICES="crosshatch blueline taimen walleye marlin sailfish ryu angler bullhead"

build_id() {
    BUILDID_FILE="./devices/$1/build_ids"
    OLD_BUILDIDS=$(cat $BUILDID_FILE)
    NEW_BUILDIDS=$(echo "$FACTURLCONTENT" | sed -n 's/<tr id="'"$1"'//p' | sed -n 's/">//p' | cut -d ' ' -f 3)
    if [[ "$OLD_BUILDIDS" != "$NEW_BUILDIDS" && -n "$NEW_BUILDIDS" ]]; then
        NEW_BUILDID=$(diff -u <(echo "$NEW_BUILDIDS") <(echo "$OLD_BUILDIDS") | sed -n '1!p' | sed -n 's/^-//p')
        echo "$NEW_BUILDIDS" > $BUILDID_FILE
    else
        return 1
    fi
}

for device in $DEVICES; do
    if build_id $device; then
        FACT_BUILDURL=$(echo "$FACTURLCONTENT" | sed -n 's/.*<td><a href=\"//p' | tr -d '"' | grep "$device-$NEW_BUILDID")
        OTA_BUILDURL=$(echo "$OTAURLCONTENT" | sed -n 's/.*<td><a href=\"//p' | sed -n 's/">.*//p' | grep "$device-ota-$NEW_BUILDID")
        MESSAGE+="*$device*: \`$NEW_BUILDID\` has been released.%0A    - Factory image: [Download]($FACT_BUILDURL)%0A    - OTA: [Download]($OTA_BUILDURL)%0A%0A"
    fi
done

tg_bot -p pm -m "$MESSAGE"
