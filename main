#!/usr/bin/env bash

URL="https://developers.google.com/android/images"

# fetch all devices and remove the stuff we don't want
# (i.e. unsupported devices, non-devices, etc etc)
URLCONTENT=$(curl $URL)

# supported devices list
DEVICES="crosshatch blueline taimen walleye marlin sailfish ryu angler bullhead"

# fetch ALL build id's of all devices, and check if there is a new one
for devices in $DEVICES; do
    BUILDID_FILE="./devices/$devices/build_ids"
    OLD_BUILDIDS=$(cat $BUILDID_FILE)
    NEW_BUILDIDS=$(echo "$URLCONTENT" | sed -n 's/<tr id="'"$devices"'//p' | sed -n 's/">//p' | cut -d ' ' -f 3)
    if [[ "$OLD_BUILDIDS" != "$NEW_BUILDIDS" && -n "$NEW_BUILDIDS" ]]; then
        NEW_BUILDID=$(diff -u <(echo "$NEW_BUILDIDS") <(echo "$OLD_BUILDIDS") | sed -n '1!p' | sed -n 's/^-//p')
        NEW_BUILDURL=$(echo "$URLCONTENT" |grep $devices | grep $NEW_BUILDID | grep https| sed -n 's/<td><a href="//;s/"//p' | tr -d ' ')
        tg_bot -p au -m "*$devices*: '$NEW_BUILDID' is available for download! [Download here]($NEW_BUILDURL)"
        echo "$NEW_BUILDIDS" > $BUILDID_FILE
    fi
done
